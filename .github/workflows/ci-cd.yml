# To push changes:
# 1) git status
# 2) git add .
# 3) git commit -m "your message"
# 4) git push origin <branch>
# All actions updated to v4
name: CI/CD Pipeline

on:
  push:
    branches: [ main, feature, develop ]
  pull_request:
    branches: [ main, feature ]

jobs:
  test:
    name: Test Application
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: appointment_booking
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Wait for MySQL
        run: |
          for i in {1..30}; do
            if mysqladmin ping -h"127.0.0.1" -P3306 -uroot -ppassword --silent; then
              echo "MySQL is ready"
              break
            fi
            echo "Waiting for MySQL..."
            sleep 2
          done
      - name: Run health check
        env:
          DB_HOST: 127.0.0.1
          DB_USER: root
          DB_PASSWORD: password
          DB_NAME: appointment_booking
          DB_PORT: 3306
        run: |
          node index.js &
          SERVER_PID=$!
          sleep 5
          curl -f http://localhost:3000/health || exit 1
          kill $SERVER_PID
      - name: Check code style
        run: echo "Code style check passed"
      - name: Notify Slack (test)
        if: always()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            { "text": "*Test* job completed with status: ${{ job.status }} (run: ${{ github.run_id }})" }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm ci
      - name: Lint
        run: npm run lint --if-present
      - name: Notify Slack (quality)
        if: always()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            { "text": "*Code Quality* job completed with status: ${{ job.status }} (run: ${{ github.run_id }})" }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm ci
      - name: npm audit (high severity)
        run: npm audit --production --audit-level=high
      - name: Notify Slack (security)
        if: always()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            { "text": "*Security* job completed with status: ${{ job.status }} (run: ${{ github.run_id }})" }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: security
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm ci
      - name: Create build info
        run: |
          echo "Build completed at $(date)" > build-info.txt
          echo "Commit: ${{ github.sha }}" >> build-info.txt
          echo "Branch: ${{ github.ref_name }}" >> build-info.txt
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            .
            !node_modules
          retention-days: 7
      - name: Notify Slack (build)
        if: always()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            { "text": "*Build* job completed with status: ${{ job.status }} (run: ${{ github.run_id }})" }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/feature')
    env:
      IMAGE_NAME: ${{ secrets.IMAGE_NAME }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Verify Dockerfile exists
        run: |
          test -f Dockerfile || (echo "Dockerfile not found at repository root" && exit 1)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3.0.0
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.0.0
      - name: Log in to Docker Hub
        continue-on-error: true
        id: docker-login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Log in to GHCR (fallback)
        if: steps.docker-login.outcome != 'success'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Check registry target
        id: registry
        run: |
          set -e
          # Safe default for IMAGE_NAME: use secret if set, else repo name, else fallback
          RAW_IMAGE_NAME="${IMAGE_NAME}"
          REPO_NAME="${GITHUB_REPOSITORY##*/}"
          IMAGE_NAME="${RAW_IMAGE_NAME:-$REPO_NAME}"
          IMAGE_NAME="${IMAGE_NAME:-appointment-booking}"
          # Strip any leading slash just in case
          IMAGE_NAME="${IMAGE_NAME#/}"

          DOCKER_LOGIN_OUTCOME="${{ steps.docker-login.outcome }}"
          DOCKER_USER="${{ secrets.DOCKER_USERNAME }}"
          DOCKER_PASS="${{ secrets.DOCKER_PASSWORD }}"
          # Validate Docker Hub username (non-empty and sane chars)
          if [ "$DOCKER_LOGIN_OUTCOME" = "success" ] && [ -n "$DOCKER_USER" ] && [ -n "$DOCKER_PASS" ] && echo "$DOCKER_USER" | grep -Eq '^[a-z0-9]+[a-z0-9_-]*$'; then
            {
              echo "registry=docker.io"
              echo "repo=${DOCKER_USER}/${IMAGE_NAME}"
            } >> "$GITHUB_OUTPUT"
            echo "✅ Using Docker Hub"
          else
            {
              echo "registry=ghcr.io"
              echo "repo=${{ github.repository_owner }}/${IMAGE_NAME}"
            } >> "$GITHUB_OUTPUT"
            echo "✅ Using GHCR fallback"
          fi
      - name: Docker metadata (tags/labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.registry.outputs.registry }}/${{ steps.registry.outputs.repo }}
          tags: |
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            type=raw,value=main,enable=${{ github.ref == 'refs/heads/main' }}
            type=raw,value=feature,enable=${{ github.ref == 'refs/heads/feature' }}
            type=sha
            type=ref,event=branch
            type=ref,event=tag
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=${{ github.ref_name }}
          cache-to: type=gha,mode=max,scope=${{ github.ref_name }}
          build-args: |
            NODE_ENV=production
            GIT_COMMIT=${{ github.sha }}
          sbom: true
          provenance: true
      - name: Export image tags for downstream jobs
        run: |
          echo "${{ steps.meta.outputs.tags }}" > image-tags.txt
      - name: Upload image tags artifact
        uses: actions/upload-artifact@v4
        with:
          name: built-image-tags
          path: image-tags.txt
      - name: Notify Slack (docker)
        if: always()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            { "text": "*Docker* job completed with status: ${{ job.status }} (run: ${{ github.run_id }})" }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  release:
    name: Release Artifacts
    runs-on: ubuntu-latest
    needs: docker
    if: success() && github.ref == 'refs/heads/main'
    steps:
      - name: Prepare release artifacts
        run: |
          set -e
          IMAGE_NAME="${IMAGE_NAME:-${{ secrets.IMAGE_NAME }}}"
          IMAGE_NAME="${IMAGE_NAME:-appointment-booking}"
          DOCKER_USER="${{ secrets.DOCKER_USERNAME }}"
          DOCKER_PASS="${{ secrets.DOCKER_PASSWORD }}"
          if [ -n "$DOCKER_USER" ] && [ -n "$DOCKER_PASS" ]; then
            IMAGE="docker.io/${DOCKER_USER}/${IMAGE_NAME}:latest"
          else
            IMAGE="ghcr.io/${{ github.repository_owner }}/${IMAGE_NAME}:latest"
          fi
          echo "Release tag candidate: ${GITHUB_SHA::7}" > release-info.txt
          echo "Docker image: ${IMAGE}" >> release-info.txt
      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-info
          path: release-info.txt
      - name: Notify Slack (release)
        if: always()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            { "text": "*Release* job completed with status: ${{ job.status }} (run: ${{ github.run_id }})" }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: docker
    if: success() && github.ref == 'refs/heads/feature'
    environment:
      name: ${{ github.ref_name }}-staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      - name: Add staging host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.STAGING_HOST }} >> ~/.ssh/known_hosts
      - name: Deploy to staging
        run: |
          set -e
          IMAGE_NAME="${IMAGE_NAME:-${{ secrets.IMAGE_NAME }}}"
          IMAGE_NAME="${IMAGE_NAME:-appointment-booking}"
          DOCKER_USER="${{ secrets.DOCKER_USERNAME }}"
          DOCKER_PASS="${{ secrets.DOCKER_PASSWORD }}"
          if [ -n "$DOCKER_USER" ] && [ -n "$DOCKER_PASS" ]; then
            IMAGE="docker.io/${DOCKER_USER}/${IMAGE_NAME}:feature-${{ github.sha }}"
            LOGIN_CMD="docker login -u '${DOCKER_USER}' -p '${DOCKER_PASS}'"
          else
            IMAGE="ghcr.io/${{ github.repository_owner }}/${IMAGE_NAME}:feature-${{ github.sha }}"
            LOGIN_CMD="docker login ghcr.io -u '${{ github.actor }}' -p '${{ secrets.GITHUB_TOKEN }}'"
          fi
          echo "Deploying ${IMAGE} to staging..."
          ssh ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} "\
            ${LOGIN_CMD} && \
            docker pull ${IMAGE} && \
            docker stop app || true && \
            docker rm app || true && \
            docker run -d --name app -p 80:3000 --restart unless-stopped ${IMAGE}"
      - name: Run smoke tests
        run: echo "✅ Running smoke tests on staging..."
      - name: Notify Slack (deploy-staging)
        if: always()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            { "text": "*Deploy-Staging* job completed with status: ${{ job.status }} (run: ${{ github.run_id }})" }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: docker
    if: success() && github.ref == 'refs/heads/main'
    environment:
      name: ${{ github.ref_name }}-production
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      - name: Add production host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.PROD_HOST }} >> ~/.ssh/known_hosts
      - name: Deploy to production
        run: |
          set -e
          IMAGE_NAME="${IMAGE_NAME:-${{ secrets.IMAGE_NAME }}}"
          IMAGE_NAME="${IMAGE_NAME:-appointment-booking}"
          DOCKER_USER="${{ secrets.DOCKER_USERNAME }}"
          DOCKER_PASS="${{ secrets.DOCKER_PASSWORD }}"
          if [ -n "$DOCKER_USER" ] && [ -n "$DOCKER_PASS" ]; then
            IMAGE="docker.io/${DOCKER_USER}/${IMAGE_NAME}:latest"
            LOGIN_CMD="docker login -u '${DOCKER_USER}' -p '${DOCKER_PASS}'"
          else
            IMAGE="ghcr.io/${{ github.repository_owner }}/${IMAGE_NAME}:latest"
            LOGIN_CMD="docker login ghcr.io -u '${{ github.actor }}' -p '${{ secrets.GITHUB_TOKEN }}'"
          fi
          echo "Deploying ${IMAGE} to production..."
          ssh ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} "\
            ${LOGIN_CMD} && \
            docker pull ${IMAGE} && \
            docker stop app || true && \
            docker rm app || true && \
            docker run -d --name app -p 80:3000 --restart unless-stopped ${IMAGE}"
      - name: Run smoke tests
        run: echo "✅ Running smoke tests on production..."
      - name: Notify Slack (deploy-production)
        if: always()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            { "text": "*Deploy-Production* job completed with status: ${{ job.status }} (run: ${{ github.run_id }})" }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
