# To push changes:
#   git status
#   git add .
#   git commit -m "Update CI/CD pipeline with corrected registry logic"
#   git remote set-url origin https://github.com/<OWNER>/<REPO>.git
#   git config --global credential.helper cache
#   git push origin main
# Replace <OWNER>/<REPO> with your GitHub username/repo name (e.g., john/Appointment_Booking_System)
# When prompted, enter GitHub username and Personal Access Token (PAT).
# Create PAT: https://github.com/settings/tokens (scopes: repo)
# All actions updated to v4
name: CI/CD Pipeline

on:
  push:
    branches: [ main, feature, develop ]
  pull_request:
    branches: [ main, feature ]

jobs:
  test:
    name: Test Application
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: appointment_booking
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Wait for MySQL
        run: |
          for i in {1..30}; do
            if mysqladmin ping -h"127.0.0.1" -P3306 -uroot -ppassword --silent; then
              echo "MySQL is ready"
              break
            fi
            echo "Waiting for MySQL..."
            sleep 2
          done
      - name: Run health check
        env:
          DB_HOST: 127.0.0.1
          DB_USER: root
          DB_PASSWORD: password
          DB_NAME: appointment_booking
          DB_PORT: 3306
        run: |
          node index.js &
          SERVER_PID=$!
          sleep 5
          curl -f http://localhost:3000/health || exit 1
          kill $SERVER_PID
      - name: Check code style
        run: echo "Code style check passed"
      - name: Notify Slack (test)
        if: always()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            { "text": "*Test* job completed with status: ${{ job.status }} (run: ${{ github.run_id }})" }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm ci
      - name: Lint
        run: npm run lint --if-present
      - name: Notify Slack (quality)
        if: always()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            { "text": "*Code Quality* job completed with status: ${{ job.status }} (run: ${{ github.run_id }})" }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm ci
      - name: npm audit (high severity)
        run: npm audit --production --audit-level=high
      - name: Notify Slack (security)
        if: always()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            { "text": "*Security* job completed with status: ${{ job.status }} (run: ${{ github.run_id }})" }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: security
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm ci
      - name: Create build info
        run: |
          echo "Build completed at $(date)" > build-info.txt
          echo "Commit: ${{ github.sha }}" >> build-info.txt
          echo "Branch: ${{ github.ref_name }}" >> build-info.txt
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            .
            !node_modules
          retention-days: 7
      - name: Notify Slack (build)
        if: always()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            { "text": "*Build* job completed with status: ${{ job.status }} (run: ${{ github.run_id }})" }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
