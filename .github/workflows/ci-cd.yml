# To push changes:
# 1) git status
# 2) git add .
# 3) git commit -m "your message"
# 4) git push origin <branch>
# All actions updated to v4
name: CI/CD Pipeline

on:
  push:
    branches: [ main, feature, develop ]
  pull_request:
    branches: [ main, feature ]

jobs:
  test:
    name: Test Application
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: appointment_booking
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Wait for MySQL
        run: |
          for i in {1..30}; do
            if mysqladmin ping -h"127.0.0.1" -P3306 -uroot -ppassword --silent; then
              echo "MySQL is ready"
              break
            fi
            echo "Waiting for MySQL..."
            sleep 2
          done
      - name: Run health check
        env:
          DB_HOST: 127.0.0.1
          DB_USER: root
          DB_PASSWORD: password
          DB_NAME: appointment_booking
          DB_PORT: 3306
        run: |
          node index.js &
          SERVER_PID=$!
          sleep 5
          curl -f http://localhost:3000/health || exit 1
          kill $SERVER_PID
      - name: Check code style
        run: echo "Code style check passed"
      - name: Notify Slack (test)
        if: always()
        uses: slackapi/slack-github-action@v1.27.0
        with:
          payload: |
            { "text": "*Test* job completed with status: ${{ job.status }} (run: ${{ github.run_id }})" }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm ci
      - name: Lint
        run: npm run lint --if-present
      - name: Notify Slack (quality)
        if: always()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            { "text": "*Code Quality* job completed with status: ${{ job.status }} (run: ${{ github.run_id }})" }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: quality
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm ci
      - name: npm audit (high severity)
        run: npm audit --production --audit-level=high
      - name: Notify Slack (security)
        if: always()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            { "text": "*Security* job completed with status: ${{ job.status }} (run: ${{ github.run_id }})" }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: security
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        run: npm ci
      - name: Create build info
        run: |
          echo "Build completed at $(date)" > build-info.txt
          echo "Commit: ${{ github.sha }}" >> build-info.txt
          echo "Branch: ${{ github.ref_name }}" >> build-info.txt
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            .
            !node_modules
          retention-days: 7
      - name: Notify Slack (build)
        if: always()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            { "text": "*Build* job completed with status: ${{ job.status }} (run: ${{ github.run_id }})" }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  docker:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/feature')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to Docker Hub
        continue-on-error: true
        id: docker-login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Check Docker Login Status
        id: check-login
        run: |
          if [ "${{ steps.docker-login.outcome }}" == "success" ]; then
            echo "login_success=true" >> $GITHUB_OUTPUT
            echo "✅ Docker Hub login successful"
          else
            echo "login_success=false" >> $GITHUB_OUTPUT
            echo "⚠️ Docker Hub credentials not configured - skipping image push"
            echo "ℹ️ To enable Docker builds, add DOCKER_USERNAME and DOCKER_PASSWORD secrets"
          fi
      - name: Build and push Docker image
        if: steps.check-login.outputs.login_success == 'true'
        run: |
          docker buildx build \
          --push \
          --tag "docker.io/${{ secrets.DOCKER_USERNAME }}/appointment-booking:latest" \
          --tag "docker.io/${{ secrets.DOCKER_USERNAME }}/appointment-booking:main" \
          --tag "docker.io/${{ secrets.DOCKER_USERNAME }}/appointment-booking:${{ github.sha }}" \
          --cache-from type=gha \
          --cache-to type=gha,mode=max \
          .
      - name: Notify Slack (docker)
        if: always()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            { "text": "*Docker* job completed with status: ${{ job.status }} (run: ${{ github.run_id }})" }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  release:
    name: Release Artifacts
    runs-on: ubuntu-latest
    needs: docker
    if: success() && github.ref == 'refs/heads/main'
    steps:
      - name: Prepare release artifacts
        run: |
          echo "Release tag candidate: ${GITHUB_SHA::7}" > release-info.txt
          echo "Docker image: docker.io/${{ secrets.DOCKER_USERNAME }}/appointment-booking:latest" >> release-info.txt
      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-info
          path: release-info.txt
      - name: Notify Slack (release)
        if: always()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            { "text": "*Release* job completed with status: ${{ job.status }} (run: ${{ github.run_id }})" }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: docker
    if: success() && github.ref == 'refs/heads/feature'
    environment:
      name: ${{ github.ref_name }}-staging
      url: https://staging-appointment-booking.example.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Deploy to staging
        run: |
          echo "Deploying to staging environment..."
          echo "Image: ${{ secrets.DOCKER_USERNAME }}/appointment-booking:feature-${{ github.sha }}"
          echo "⚠️ Add your staging deployment commands here"
      - name: Run smoke tests
        run: echo "✅ Running smoke tests on staging..."
      - name: Notify Slack (deploy-staging)
        if: always()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            { "text": "*Deploy-Staging* job completed with status: ${{ job.status }} (run: ${{ github.run_id }})" }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: docker
    if: success() && github.ref == 'refs/heads/main'
    environment:
      name: ${{ github.ref_name }}-production
      url: https://appointment-booking.example.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Deploy to production
        run: |
          echo "Deploying to production environment..."
          echo "Image: ${{ secrets.DOCKER_USERNAME }}/appointment-booking:latest"
          echo "⚠️ Add your production deployment commands here"
      - name: Run smoke tests
        run: echo "✅ Running smoke tests on production..."
      - name: Notify Slack (deploy-production)
        if: always()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            { "text": "*Deploy-Production* job completed with status: ${{ job.status }} (run: ${{ github.run_id }})" }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
